# 프로젝트 업데이트 내역 - 2025년 10월 28일

## 📋 업데이트 개요

**작업일**: 2025년 10월 28일
**작업자**: Claude AI
**업데이트 소스**: `C:\dev\springboot\shoppy-fullstack-app\backend\src\main`
**적용 대상**: `C:\dev\ecommerce-fullstack-app\backend\src\main`
**목적**: 수업에서 배운 최신 기능(카카오페이 결제, 주문 관리, 고객 지원) 메인 프로젝트 반영

---

## 🎯 주요 변경사항 요약

### 신규 기능 추가 (3개)
1. **카카오페이 QR 결제 시스템** - 온라인 결제 기능 통합
2. **주문 관리 시스템** - 주문 저장 및 주문 상세 관리
3. **고객 지원 시스템** - FAQ, 공지사항, 문의 게시판

### 기존 기능 개선
1. **장바구니 시스템 개선** - 데이터베이스 뷰 활용, 성능 최적화
2. **보안 설정 업데이트** - 신규 엔드포인트 허용 추가
3. **DTO 구조 개선** - 관심사 분리 (CartItem ↔ CartListResponse)

---

## 📦 생성된 파일 목록 (18개)

### 1. DTO 클래스 (5개)

#### KakaoPay.java
**위치**: `dto/KakaoPay.java`
**설명**: 카카오페이 결제 정보 데이터 전송 객체
```java
- orderId: 주문번호 (UUID)
- userId: 사용자 ID
- itemName: 상품명
- qty: 수량
- totalAmount: 총 금액
- receiver: 수령인 정보 (내부 클래스)
- paymentInfo: 결제 정보 (내부 클래스)
- cidList: 장바구니 ID 리스트
```

#### KakaoReadyResponse.java
**위치**: `dto/KakaoReadyResponse.java`
**설명**: 카카오페이 결제 준비 응답 DTO
```java
- tid: 결제 고유 번호
- next_redirect_pc_url: QR 코드 URL
```

#### KakaoApproveResponse.java
**위치**: `dto/KakaoApproveResponse.java`
**설명**: 카카오페이 결제 승인 응답 DTO
```java
- tid: 결제 고유 번호
- cid: 가맹점 코드
- status: 결제 상태
- partnerOrderId: 가맹점 주문번호
- partnerUserId: 가맹점 회원 ID
- paymentMethodType: 결제 수단
- amount: 결제 금액 상세 (내부 클래스)
- approvedAt: 승인 시각
```
**특징**: @JsonNaming(SnakeCaseStrategy.class) 사용

#### Support.java
**위치**: `dto/Support.java`
**설명**: 고객 지원 게시글 DTO
```java
- sid: 지원 ID
- title: 제목
- content: 내용
- stype: 지원 타입 (all, faq, notice, general)
- hits: 조회수
- rdate: 등록일
```

#### CartListResponse.java
**위치**: `dto/CartListResponse.java`
**설명**: 장바구니 목록 조회 응답 DTO (회원+상품+장바구니 통합)
```java
- id: 회원 ID
- mname: 회원 이름
- phone: 전화번호
- email: 이메일
- pid: 상품 ID
- name: 상품명
- info: 상품 정보
- image: 이미지
- price: 가격
- size: 사이즈
- qty: 수량
- cid: 장바구니 ID
- totalPrice: 총 가격
```

---

### 2. Controller 클래스 (2개)

#### KakaoPayController.java
**위치**: `controller/KakaoPayController.java`
**경로**: `/payment`

**엔드포인트**:
- `POST /payment/kakao/ready` - 결제 준비 (QR 코드 생성)
- `GET /payment/qr/success?orderId={orderId}&pg_token={token}` - 결제 성공 콜백
- `GET /payment/qr/cancel?orderId={orderId}` - 결제 취소 콜백
- `GET /payment/qr/fail?orderId={orderId}` - 결제 실패 콜백

**주요 기능**:
```java
- UUID 기반 주문번호 자동 생성
- 카카오페이 API 호출 (KakaoPayService)
- 결제 완료 시 주문 저장 (OrderService)
- 프론트엔드로 리다이렉트 처리
```

#### SupportController.java
**위치**: `controller/SupportController.java`
**경로**: `/support`

**엔드포인트**:
- `POST /support/list` - 고객 지원 목록 조회

**주요 기능**:
```java
- 전체 목록 조회 (stype="all")
- 타입별 필터링 조회 (stype="faq", "notice", "general")
```

---

### 3. Service 클래스 (5개)

#### KakaoPayService.java
**위치**: `service/KakaoPayService.java`

**주요 메서드**:
```java
- kakaoPayReady(KakaoPay): 결제 준비 API 호출
- approve(tid, userId, orderId, pgToken): 결제 승인 API 호출
- findByTid(orderId): TID 조회
- findByUserId(orderId): 사용자 ID 조회
```

**기술 스택**:
- RestTemplate: 카카오페이 API 통신
- ConcurrentHashMap: TID 및 사용자 정보 임시 저장
- @Value: application.yml 설정 주입

**카카오페이 API 설정**:
```yaml
kakao.pay.host: https://kapi.kakao.com
kakao.pay.admin-key: 관리자 키
kakao.pay.cid: 가맹점 코드
```

#### OrderService.java & OrderServiceImpl.java
**위치**: `service/OrderService.java`, `service/OrderServiceImpl.java`

**주요 메서드**:
```java
- save(KakaoPay): 주문 저장 (@Transactional)
  1. orders 테이블에 주문 정보 저장
  2. order_detail 테이블에 주문 상세 저장
  3. cart 테이블에서 주문 상품 삭제
```

**트랜잭션 처리**:
- @Transactional 어노테이션 사용
- 3가지 작업의 원자성 보장 (All or Nothing)

#### SupportService.java & SupportServiceImpl.java
**위치**: `service/SupportService.java`, `service/SupportServiceImpl.java`

**주요 메서드**:
```java
- findAll(Support): 고객 지원 목록 조회
  - stype="all": 전체 조회
  - stype 값이 있으면: 타입별 조회
```

---

### 4. Repository 클래스 (4개)

#### OrderRepository.java & JdbcTemplateOrderRepository.java
**위치**: `repository/OrderRepository.java`, `repository/JdbcTemplateOrderRepository.java`

**주요 메서드**:
```java
- saveOrders(KakaoPay): orders 테이블에 주문 정보 저장
- saveOrderDetail(KakaoPay): order_detail 테이블에 주문 상세 저장
- deleteCartItem(List<Integer> cidList): 장바구니 아이템 삭제
```

**SQL 쿼리**:
```sql
-- saveOrders
INSERT INTO orders(
    order_code, member_id, shipping_fee, discount_amount, total_amount,
    receiver_name, receiver_phone, zipcode, address1, address2, memo, odate
) VALUES (?,?,?,?,?,?,?,?,?,?,?, now())

-- saveOrderDetail (NamedParameterJdbcTemplate 사용)
INSERT INTO order_detail(order_code, pid, pname, size, qty, pid_total_price, discount)
SELECT :orderCode, pid, name, size, qty, totalPrice, :discount
FROM view_cartlist
WHERE cid IN (:cidList)

-- deleteCartItem
DELETE FROM cart WHERE cid IN (:cidList)
```

#### SupportRepository.java & JdbcTemplateSupportRepository.java
**위치**: `repository/SupportRepository.java`, `repository/JdbcTemplateSupportRepository.java`

**주요 메서드**:
```java
- findAll(): 전체 지원 목록 조회
- findAll(Support): 타입별 지원 목록 조회
```

**SQL 쿼리**:
```sql
-- 전체 조회
SELECT sid, title, stype, hits, rdate FROM support

-- 타입별 조회
SELECT sid, title, stype, hits, rdate FROM support WHERE stype = ?
```

---

### 5. 설정 파일 (2개)

#### application.yml (신규)
**위치**: `src/main/resources/application.yml`

```yaml
kakao:
  pay:
    host: https://kapi.kakao.com
    admin-key: ed1df4b9d47e4cb603d7dbc8e7124cbb  # 테스트용
    cid: TC0ONETIME                              # 테스트 가맹점 코드
    ready-path: /payment/ready
    approve-path: /payment/approve
```

**주의사항**:
- admin-key는 테스트용입니다
- 프로덕션 환경에서는 환경변수로 관리 권장
- TC0ONETIME은 카카오페이 테스트 가맹점 코드

#### migration_update.sql (신규)
**위치**: `database/migration_update.sql`

**생성되는 객체**:
1. orders 테이블 (주문 정보)
2. order_detail 테이블 (주문 상세)
3. support 테이블 (고객 지원)
4. view_cartlist 뷰 (장바구니 통합 뷰)

**실행 방법**:
```bash
mysql -u root -p < C:\dev\ecommerce-fullstack-app\database\migration_update.sql
```

---

## 🔧 수정된 파일 목록 (7개)

### 1. SecurityConfig.java
**위치**: `config/SecurityConfig.java`
**변경 라인**: Line 29

**변경 전**:
```java
.requestMatchers("/member/**", "/product/**", "/cart/**").permitAll()
```

**변경 후**:
```java
.requestMatchers("/member/**", "/product/**", "/cart/**", "/support/**","/payment/**").permitAll()
```

**변경 이유**: 새로운 엔드포인트 허용 추가

---

### 2. CartItem.java
**위치**: `dto/CartItem.java`
**변경 라인**: Line 15

**변경 전**:
```java
private int checkQty;
private String type;

// Product information (from join)
private String image;
private String name;
private int price;
```

**변경 후**:
```java
private int checkQty;
private String type;
private int sumQty;
```

**변경 이유**:
- Product 정보는 CartListResponse로 분리
- sumQty 필드 추가 (총 수량 조회용)
- 관심사 분리 (SRP 원칙)

---

### 3. CartRepository.java
**위치**: `repository/CartRepository.java`

**변경 전**:
```java
public interface CartRepository {
    int updateQty(CartItem cartItem);
    CartItem checkQty(CartItem cartItem);
    int add(CartItem cartItem);
    List<CartItem> findByUserId(String id);
    int remove(String cid);
    int countByUserId(String id);
}
```

**변경 후**:
```java
public interface CartRepository {
    int deleteItem(CartItem cartItem);
    List<CartListResponse> findList(CartItem cartItem);
    CartItem getCount(CartItem cartItem);
    int updateQty(CartItem cartItem);
    CartItem checkQty(CartItem cartItem);
    int add(CartItem cartItem);
}
```

**변경 이유**:
- 메서드명 명확화 (remove → deleteItem)
- 반환 타입 개선 (List<CartItem> → List<CartListResponse>)
- 파라미터 일관성 (String → CartItem 객체)
- 카운트 반환 타입 변경 (int → CartItem)

---

### 4. JdbcTemplateCartRepository.java
**위치**: `repository/JdbcTemplateCartRepository.java`

#### 주요 변경 1: findList() - 데이터베이스 뷰 사용

**변경 전**:
```java
@Override
public List<CartItem> findByUserId(String id) {
    String sql = """
            SELECT c.cid, c.size, c.qty, c.pid, c.id, c.cdate,
                   p.image, p.name, p.price
            FROM cart c
            INNER JOIN product p ON c.pid = p.pid
            WHERE c.id = ?
            ORDER BY c.cdate DESC
            """;
    return jdbcTemplate.query(sql, new BeanPropertyRowMapper<>(CartItem.class), id);
}
```

**변경 후**:
```java
@Override
public List<CartListResponse> findList(CartItem cartItem) {
    String sql = """
            select id, mname, phone, email, pid, name, info, image, price, size, qty, cid, totalPrice
            from view_cartlist
            where id = ?
            """;
    Object[] params = { cartItem.getId() };
    return jdbcTemplate.query(sql,
            new BeanPropertyRowMapper<>(CartListResponse.class), params);
}
```

**개선 사항**:
- 데이터베이스 뷰(view_cartlist) 사용
- 회원 정보(mname, phone, email) 추가 조회
- totalPrice 계산된 필드 조회
- 복잡한 JOIN 로직 캡슐화

#### 주요 변경 2: checkQty() - 쿼리 최적화

**변경 전**:
```java
@Override
public CartItem checkQty(CartItem cartItem) {
    String sql = """
            SELECT cid, sum(pid=? AND size=? and id=?) AS checkQty
            FROM cart
            GROUP BY cid, id
            ORDER BY checkQty desc
            LIMIT 1
            """;
    Object[] params = { cartItem.getPid(), cartItem.getSize(), cartItem.getId() };
    return jdbcTemplate.queryForObject(sql, new BeanPropertyRowMapper<>(CartItem.class), params);
}
```

**변경 후**:
```java
@Override
public CartItem checkQty(CartItem cartItem) {
    String sql = """
            SELECT
               ifnull(MAX(cid), 0) AS cid,
               COUNT(*) AS checkQty
             FROM cart
             WHERE pid = ? AND size = ? AND id = ?
            """;

    Object[] params = {
            cartItem.getPid(), cartItem.getSize(), cartItem.getId()
    };
    CartItem resultCartItem = jdbcTemplate.queryForObject(sql, new BeanPropertyRowMapper<>(CartItem.class), params);
    return resultCartItem;
}
```

**개선 사항**:
- GROUP BY 제거, WHERE 절 사용으로 쿼리 최적화
- IFNULL로 NULL 처리 개선
- 불필요한 ORDER BY와 LIMIT 제거

#### 주요 변경 3: getCount() - 반환 타입 변경

**변경 전**:
```java
@Override
public int countByUserId(String id) {
    String sql = "SELECT IFNULL(SUM(qty), 0) FROM cart WHERE id = ?";
    return jdbcTemplate.queryForObject(sql, Integer.class, id);
}
```

**변경 후**:
```java
@Override
public CartItem getCount(CartItem cartItem) {
    String sql = "select ifnull(sum(qty), 0) as sumQty from cart where id = ?";
    return jdbcTemplate.queryForObject(sql, new BeanPropertyRowMapper<>(CartItem.class), cartItem.getId());
}
```

**개선 사항**:
- 반환 타입: int → CartItem 객체
- 확장성 향상 (향후 추가 정보 전달 가능)

#### 주요 변경 4: deleteItem() - 파라미터 변경

**변경 전**:
```java
@Override
public int remove(String cid) {
    String sql = "DELETE FROM cart WHERE cid = ?";
    return jdbcTemplate.update(sql, cid);
}
```

**변경 후**:
```java
@Override
public int deleteItem(CartItem cartItem) {
    String sql = """
            delete from cart where cid = ?
            """;
    return jdbcTemplate.update(sql, cartItem.getCid());
}
```

**개선 사항**:
- 파라미터 일관성 (모든 메서드가 CartItem 객체 사용)
- 메서드명 명확화

---

### 5. CartService.java
**위치**: `service/CartService.java`

**변경 전**:
```java
public interface CartService {
    int updateQty(CartItem cartItem);
    CartItem checkQty(CartItem cartItem);
    int add(CartItem cartItem);
    List<CartItem> getCartList(String id);
    int remove(String cid);
    int getCartCount(String id);
}
```

**변경 후**:
```java
public interface CartService {
    int deleteItem(CartItem cartItem);
    List<CartListResponse> findList(CartItem cartItem);
    CartItem getCount(CartItem cartItem);
    int updateQty(CartItem cartItem);
    CartItem checkQty(CartItem cartItem);
    int add(CartItem cartItem);
}
```

**변경 이유**: Repository 인터페이스 변경에 따른 동기화

---

### 6. CartServiceImpl.java
**위치**: `service/CartServiceImpl.java`

**변경 전**:
```java
@Service
public class CartServiceImpl implements CartService{
    private CartRepository cartRepository;

    @Override
    public List<CartItem> getCartList(String id) {
        return cartRepository.findByUserId(id);
    }

    @Override
    public int remove(String cid) {
        return cartRepository.remove(cid);
    }

    @Override
    public int getCartCount(String id) {
        return cartRepository.countByUserId(id);
    }
    // ... 기타 메서드
}
```

**변경 후**:
```java
@Service
public class CartServiceImpl implements CartService{
    private CartRepository cartRepository;

    @Override
    public int deleteItem(CartItem cartItem) {
        return cartRepository.deleteItem(cartItem);
    }

    @Override
    public List<CartListResponse> findList(CartItem cartItem) {
        return cartRepository.findList(cartItem);
    }

    @Override
    public CartItem getCount(CartItem cartItem) {
        return cartRepository.getCount(cartItem);
    }
    // ... 기타 메서드
}
```

**변경 이유**: Repository 메서드 변경에 따른 구현 업데이트

---

### 7. CartController.java
**위치**: `controller/CartController.java`

**변경 전**:
```java
@RestController
@RequestMapping("/cart")
public class CartController {
    private CartService cartService;

    @PostMapping("/list")
    public List<CartItem> getCartList(@RequestBody CartItem cartItem) {
        return cartService.getCartList(cartItem.getId());
    }

    @PostMapping("/remove")
    public int remove(@RequestBody CartItem cartItem) {
        return cartService.remove(cartItem.getCid());
    }

    @PostMapping("/count")
    public int getCartCount(@RequestBody CartItem cartItem) {
        return cartService.getCartCount(cartItem.getId());
    }
}
```

**변경 후**:
```java
@RestController
@RequestMapping("/cart")
public class CartController {
    private CartService cartService;

    @PostMapping("/deleteItem")
    public int deleteItem(@RequestBody CartItem cartItem) {
        return cartService.deleteItem(cartItem);
    }

    @PostMapping("/list")
    public List<CartListResponse> findList(@RequestBody CartItem cartItem) {
        return cartService.findList(cartItem);
    }

    @PostMapping("/count")
    public CartItem count(@RequestBody CartItem cartItem) {
        return cartService.getCount(cartItem);
    }
}
```

**API 변경 사항**:

| 이전 | 변경 후 | 비고 |
|------|---------|------|
| POST /cart/remove | POST /cart/deleteItem | 엔드포인트 변경 |
| 반환: int | 반환: int | 변경 없음 |
| POST /cart/list | POST /cart/list | 경로 동일 |
| 반환: List<CartItem> | 반환: List<CartListResponse> | 반환 타입 변경 |
| POST /cart/count | POST /cart/count | 경로 동일 |
| 반환: int | 반환: CartItem | 반환 타입 변경 |

**변경 이유**:
- RESTful API 네이밍 개선
- 응답 데이터 구조 개선 (회원 정보 포함)
- 확장성 향상

---

## 🗄️ 데이터베이스 스키마 변경

### 1. orders 테이블 (신규)

```sql
CREATE TABLE orders (
    oid INT AUTO_INCREMENT PRIMARY KEY,
    order_code VARCHAR(100) NOT NULL UNIQUE,
    member_id VARCHAR(50) NOT NULL,
    shipping_fee INT DEFAULT 0,
    discount_amount INT DEFAULT 0,
    total_amount INT NOT NULL,
    receiver_name VARCHAR(100) NOT NULL,
    receiver_phone VARCHAR(20) NOT NULL,
    zipcode VARCHAR(10),
    address1 VARCHAR(200),
    address2 VARCHAR(200),
    memo TEXT,
    odate DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_member_id (member_id),
    INDEX idx_order_code (order_code),
    INDEX idx_odate (odate)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**필드 설명**:
- `oid`: 주문 ID (자동증가 PK)
- `order_code`: UUID 기반 주문 코드 (Unique)
- `member_id`: 회원 ID (FK 개념)
- `shipping_fee`: 배송비
- `discount_amount`: 할인 금액
- `total_amount`: 총 결제 금액
- `receiver_*`: 수령인 정보 (이름, 전화번호, 주소)
- `odate`: 주문 날짜

**인덱스**:
- `idx_member_id`: 회원별 주문 조회 최적화
- `idx_order_code`: 주문 코드 검색 최적화
- `idx_odate`: 날짜별 주문 조회 최적화

---

### 2. order_detail 테이블 (신규)

```sql
CREATE TABLE order_detail (
    odid INT AUTO_INCREMENT PRIMARY KEY,
    order_code VARCHAR(100) NOT NULL,
    pid INT NOT NULL,
    pname VARCHAR(200) NOT NULL,
    size VARCHAR(10),
    qty INT NOT NULL,
    pid_total_price INT NOT NULL,
    discount INT DEFAULT 0,
    INDEX idx_order_code (order_code),
    INDEX idx_pid (pid),
    FOREIGN KEY (order_code) REFERENCES orders(order_code) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**필드 설명**:
- `odid`: 주문 상세 ID (자동증가 PK)
- `order_code`: 주문 코드 (FK)
- `pid`: 상품 ID
- `pname`: 상품명 (스냅샷)
- `size`: 사이즈
- `qty`: 수량
- `pid_total_price`: 상품 총 가격
- `discount`: 할인 금액

**외래키**:
- `order_code`: orders 테이블 참조 (CASCADE 삭제)

---

### 3. support 테이블 (신규)

```sql
CREATE TABLE support (
    sid INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    content TEXT,
    stype VARCHAR(50) DEFAULT 'general',
    hits INT DEFAULT 0,
    rdate DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_stype (stype),
    INDEX idx_rdate (rdate)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**필드 설명**:
- `sid`: 지원 ID (자동증가 PK)
- `title`: 제목
- `content`: 내용
- `stype`: 지원 타입 (general, faq, notice)
- `hits`: 조회수
- `rdate`: 등록일

**인덱스**:
- `idx_stype`: 타입별 조회 최적화
- `idx_rdate`: 날짜별 조회 최적화

---

### 4. view_cartlist 뷰 (신규)

```sql
CREATE OR REPLACE VIEW view_cartlist AS
SELECT
    m.id,
    m.name AS mname,
    m.phone,
    m.email,
    p.pid,
    p.name,
    p.info,
    p.image,
    p.price,
    c.size,
    c.qty,
    c.cid,
    (p.price * c.qty) AS totalPrice
FROM cart c
INNER JOIN member m ON c.id = m.id
INNER JOIN product p ON c.pid = p.pid;
```

**뷰 설명**:
- cart, member, product 테이블 3-way JOIN
- 회원 정보 + 상품 정보 + 장바구니 정보 통합
- totalPrice 계산 필드 제공
- 복잡한 JOIN 로직 캡슐화

**활용**:
```java
// JdbcTemplateCartRepository.findList()에서 사용
SELECT * FROM view_cartlist WHERE id = ?
```

---

## 🔄 API 변경사항

### 신규 엔드포인트 (6개)

#### 1. 카카오페이 결제 준비
```
POST /payment/kakao/ready
```

**Request Body**:
```json
{
  "userId": "user123",
  "itemName": "상품명 외 2건",
  "qty": "3",
  "totalAmount": "50000",
  "receiver": {
    "name": "홍길동",
    "phone": "010-1234-5678",
    "zipcode": "12345",
    "address1": "서울시 강남구",
    "address2": "테헤란로 123",
    "memo": "문 앞에 놔주세요"
  },
  "paymentInfo": {
    "shippingFee": 3000,
    "discountAmount": 5000,
    "totalAmount": 48000
  },
  "cidList": [1, 2, 3]
}
```

**Response**:
```json
{
  "tid": "T1234567890123456789",
  "next_redirect_pc_url": "https://qr.kakaopay.com/xxxx"
}
```

---

#### 2. 카카오페이 결제 성공 콜백
```
GET /payment/qr/success?orderId={orderId}&pg_token={token}
```

**Response**: 리다이렉트
```
HTTP 302 Found
Location: http://localhost:3000/payResult?orderId={orderId}&status=success
```

---

#### 3. 카카오페이 결제 취소 콜백
```
GET /payment/qr/cancel?orderId={orderId}
```

**Response**:
```json
{
  "status": "CANCEL",
  "orderId": "uuid-xxx"
}
```

---

#### 4. 카카오페이 결제 실패 콜백
```
GET /payment/qr/fail?orderId={orderId}
```

**Response**:
```json
{
  "status": "FAIL",
  "orderId": "uuid-xxx"
}
```

---

#### 5. 고객 지원 목록 조회
```
POST /support/list
```

**Request Body**:
```json
{
  "stype": "all"  // 또는 "faq", "notice", "general"
}
```

**Response**:
```json
[
  {
    "sid": 1,
    "title": "배송 관련 문의",
    "stype": "faq",
    "hits": 100,
    "rdate": "2025-10-28 10:00:00"
  },
  {
    "sid": 2,
    "title": "반품 정책",
    "stype": "faq",
    "hits": 85,
    "rdate": "2025-10-28 10:05:00"
  }
]
```

---

### 변경된 엔드포인트 (3개)

#### 1. 장바구니 삭제 (엔드포인트 변경)
```
POST /cart/deleteItem  (이전: /cart/remove)
```

**Request Body**:
```json
{
  "cid": 123
}
```

**Response**: `int` (삭제된 행 수)

---

#### 2. 장바구니 목록 조회 (응답 타입 변경)
```
POST /cart/list
```

**Request Body**:
```json
{
  "id": "user123"
}
```

**Response 변경**:

**이전** (List<CartItem>):
```json
[
  {
    "cid": 1,
    "pid": 101,
    "size": "M",
    "qty": 2,
    "image": "image1.jpg",
    "name": "상품1",
    "price": 10000
  }
]
```

**변경 후** (List<CartListResponse>):
```json
[
  {
    "cid": 1,
    "pid": 101,
    "size": "M",
    "qty": 2,
    "name": "상품1",
    "info": "상품 설명",
    "image": "image1.jpg",
    "price": 10000,
    "totalPrice": 20000,
    "id": "user123",
    "mname": "홍길동",
    "phone": "010-1234-5678",
    "email": "user@example.com"
  }
]
```

**추가된 필드**:
- `mname`: 회원 이름
- `phone`: 전화번호
- `email`: 이메일
- `info`: 상품 정보
- `totalPrice`: 총 가격 (price * qty)

---

#### 3. 장바구니 수량 조회 (응답 타입 변경)
```
POST /cart/count
```

**Request Body**:
```json
{
  "id": "user123"
}
```

**Response 변경**:

**이전**: `int`
```json
5
```

**변경 후**: `CartItem` 객체
```json
{
  "sumQty": 5
}
```

**변경 이유**: 향후 추가 정보 전달 가능 (확장성)

---

## 📊 아키텍처 개선사항

### 1. 관심사 분리 (Separation of Concerns)

**이전**: CartItem이 장바구니 + 상품 정보 혼재
```java
public class CartItem {
    private int cid;
    private String id;
    // ...
    private String image;  // Product 정보
    private String name;   // Product 정보
    private int price;     // Product 정보
}
```

**개선**: 역할별 DTO 분리
```java
// 장바구니 기본 정보
public class CartItem {
    private int cid;
    private String id;
    private int sumQty;
}

// 장바구니 상세 조회용 (회원+상품+장바구니)
public class CartListResponse {
    private String id;
    private String mname;     // Member
    private String phone;     // Member
    private int pid;          // Product
    private String name;      // Product
    private int cid;          // Cart
    private int totalPrice;   // Calculated
}
```

**장점**:
- Single Responsibility Principle (단일 책임 원칙)
- 유지보수성 향상
- 코드 가독성 향상

---

### 2. 데이터베이스 뷰 활용

**이전**: 복잡한 JOIN 쿼리를 코드에서 직접 작성
```java
String sql = """
    SELECT c.cid, c.size, c.qty, c.pid, c.id, c.cdate,
           p.image, p.name, p.price
    FROM cart c
    INNER JOIN product p ON c.pid = p.pid
    WHERE c.id = ?
    """;
```

**개선**: 데이터베이스 뷰로 캡슐화
```java
String sql = """
    SELECT id, mname, phone, email, pid, name, info, image, price, size, qty, cid, totalPrice
    FROM view_cartlist
    WHERE id = ?
    """;
```

**장점**:
- 복잡한 JOIN 로직 데이터베이스 레벨에서 관리
- SQL 코드 간결화
- 성능 최적화 용이 (뷰 최적화)
- 데이터 일관성 보장

---

### 3. 쿼리 최적화

**이전**: GROUP BY + ORDER BY + LIMIT 조합
```sql
SELECT cid, sum(pid=? AND size=? and id=?) AS checkQty
FROM cart
GROUP BY cid, id
ORDER BY checkQty desc
LIMIT 1
```

**개선**: WHERE 절 사용
```sql
SELECT
   ifnull(MAX(cid), 0) AS cid,
   COUNT(*) AS checkQty
FROM cart
WHERE pid = ? AND size = ? AND id = ?
```

**성능 개선**:
- 인덱스 활용 가능 (WHERE 절)
- 불필요한 정렬 제거
- 실행 계획 개선

---

### 4. 트랜잭션 관리

**주문 저장 프로세스**:
```java
@Transactional
public int save(KakaoPay kakaoPay) {
    // 1. orders 테이블에 주문 저장
    int rows = orderRepository.saveOrders(kakaoPay);

    // 2. order_detail 테이블에 주문 상세 저장
    int rows_detail = orderRepository.saveOrderDetail(kakaoPay);

    // 3. cart 테이블에서 주문 상품 삭제
    int rows_cart = orderRepository.deleteCartItem(kakaoPay.getCidList());

    return rows;
}
```

**트랜잭션 보장**:
- 3가지 작업의 원자성 보장 (All or Nothing)
- 중간에 실패 시 전체 롤백
- 데이터 일관성 유지

---

### 5. 확장성 향상

**반환 타입 변경 (int → 객체)**:

**이전**:
```java
@PostMapping("/count")
public int getCartCount(@RequestBody CartItem cartItem) {
    return cartService.getCartCount(cartItem.getId());
}
```

**개선**:
```java
@PostMapping("/count")
public CartItem count(@RequestBody CartItem cartItem) {
    return cartService.getCount(cartItem);
}
```

**장점**:
- 향후 추가 정보 전달 가능
- API 하위 호환성 유지 가능
- 클라이언트 코드 변경 최소화

---

## 🧪 테스트 가이드

### 1. 데이터베이스 마이그레이션 테스트

```bash
# 1. MySQL 접속
mysql -u root -p

# 2. 데이터베이스 선택
USE ecommerce;

# 3. 마이그레이션 스크립트 실행
SOURCE C:\dev\ecommerce-fullstack-app\database\migration_update.sql;

# 4. 테이블 확인
SHOW TABLES;

# 5. 뷰 확인
SHOW FULL TABLES WHERE Table_type = 'VIEW';

# 6. view_cartlist 뷰 테스트
SELECT * FROM view_cartlist LIMIT 5;

# 7. support 샘플 데이터 확인
SELECT * FROM support;
```

---

### 2. 애플리케이션 빌드 및 실행

```bash
# 1. 프로젝트 디렉토리 이동
cd C:\dev\ecommerce-fullstack-app\backend

# 2. Maven 클린 빌드
mvn clean install

# 3. 애플리케이션 실행
mvn spring-boot:run

# 또는 JAR 파일 실행
java -jar target/ecommerce-fullstack-app-0.0.1-SNAPSHOT.jar
```

**예상 로그**:
```
Started EcommerceFullstackAppApplication in 5.123 seconds
```

---

### 3. API 테스트 (Postman/curl)

#### 카카오페이 결제 준비 테스트
```bash
curl -X POST http://localhost:8080/payment/kakao/ready \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "test01",
    "itemName": "테스트 상품",
    "qty": "1",
    "totalAmount": "10000",
    "receiver": {
      "name": "홍길동",
      "phone": "010-1234-5678",
      "zipcode": "12345",
      "address1": "서울시",
      "address2": "강남구",
      "memo": "테스트"
    },
    "paymentInfo": {
      "shippingFee": 3000,
      "discountAmount": 0,
      "totalAmount": 13000
    },
    "cidList": [1]
  }'
```

#### 장바구니 목록 조회 테스트
```bash
curl -X POST http://localhost:8080/cart/list \
  -H "Content-Type: application/json" \
  -d '{"id": "test01"}'
```

#### 고객 지원 목록 조회 테스트
```bash
curl -X POST http://localhost:8080/support/list \
  -H "Content-Type: application/json" \
  -d '{"stype": "all"}'
```

---

### 4. 데이터베이스 연동 테스트

```sql
-- 1. 장바구니 데이터 확인
SELECT * FROM cart WHERE id = 'test01';

-- 2. view_cartlist 뷰 테스트
SELECT * FROM view_cartlist WHERE id = 'test01';

-- 3. 주문 데이터 확인 (결제 후)
SELECT * FROM orders WHERE member_id = 'test01';

-- 4. 주문 상세 확인
SELECT * FROM order_detail WHERE order_code = '주문코드';

-- 5. 고객 지원 데이터 확인
SELECT * FROM support WHERE stype = 'faq';
```

---

## ⚠️ 주의사항

### 1. 데이터베이스 스크립트 실행 필수
- **반드시** `migration_update.sql` 스크립트를 실행해야 합니다
- 스크립트 미실행 시 애플리케이션 오류 발생
- orders, order_detail, support 테이블 없음
- view_cartlist 뷰 없음 (장바구니 조회 실패)

### 2. 카카오페이 API 키 관리
- 현재 `application.yml`에 하드코딩된 admin-key는 **테스트용**
- 프로덕션 환경에서는 **반드시 환경변수** 사용
```yaml
# 권장 방법
kakao:
  pay:
    admin-key: ${KAKAO_ADMIN_KEY}
```

```bash
# 환경변수 설정 (Windows)
set KAKAO_ADMIN_KEY=실제발급받은키

# 환경변수 설정 (Linux/Mac)
export KAKAO_ADMIN_KEY=실제발급받은키
```

### 3. 카카오페이 테스트 모드
- 현재 CID: `TC0ONETIME` (테스트 가맹점 코드)
- 실제 결제는 이루어지지 않음
- 프로덕션 배포 시 실제 가맹점 코드로 변경 필요

### 4. 프론트엔드 API 변경 반영 필요
- 장바구니 API 변경사항 프론트엔드 반영 필요
  - `/cart/remove` → `/cart/deleteItem`
  - `/cart/list` 응답 타입 변경 (CartListResponse)
  - `/cart/count` 응답 타입 변경 (CartItem 객체)

### 5. 트랜잭션 관리
- OrderServiceImpl의 save() 메서드는 @Transactional 적용
- 데이터베이스 연결 풀 설정 확인
- 트랜잭션 타임아웃 설정 검토

---

## 🔍 트러블슈팅

### 문제 1: view_cartlist 뷰를 찾을 수 없음
**증상**:
```
Table 'ecommerce.view_cartlist' doesn't exist
```

**해결**:
```sql
-- 마이그레이션 스크립트 재실행
SOURCE C:\dev\ecommerce-fullstack-app\database\migration_update.sql;

-- 또는 직접 뷰 생성
CREATE OR REPLACE VIEW view_cartlist AS
SELECT
    m.id,
    m.name AS mname,
    m.phone,
    m.email,
    p.pid,
    p.name,
    p.info,
    p.image,
    p.price,
    c.size,
    c.qty,
    c.cid,
    (p.price * c.qty) AS totalPrice
FROM cart c
INNER JOIN member m ON c.id = m.id
INNER JOIN product p ON c.pid = p.pid;
```

---

### 문제 2: 카카오페이 API 호출 실패
**증상**:
```
Kakao Pay Ready 실패: 401 Unauthorized
```

**해결**:
1. application.yml의 admin-key 확인
2. 카카오 개발자 콘솔에서 키 상태 확인
3. 네트워크 연결 확인 (방화벽, 프록시)

---

### 문제 3: @Transactional 동작하지 않음
**증상**: 주문 저장 중 오류 발생 시 장바구니가 삭제됨

**해결**:
1. @EnableTransactionManagement 확인
```java
@Configuration
@EnableTransactionManagement
public class AppConfig {
    // ...
}
```

2. DataSource 설정 확인
```properties
spring.datasource.hikari.auto-commit=false
```

---

### 문제 4: 빌드 실패 (컴파일 오류)
**증상**:
```
package com.springboot.ecommerce_fullstack_app.dto does not exist
```

**해결**:
```bash
# Maven 클린 후 재빌드
mvn clean
mvn install

# IntelliJ IDEA의 경우
File > Invalidate Caches / Restart
```

---

## 📈 성능 개선 효과

### 1. 쿼리 성능 개선

#### checkQty() 메서드
**이전**:
```sql
-- 실행 계획: Using filesort, Using temporary
SELECT cid, sum(pid=? AND size=? and id=?) AS checkQty
FROM cart
GROUP BY cid, id
ORDER BY checkQty desc
LIMIT 1
```

**개선**:
```sql
-- 실행 계획: Using where, Using index
SELECT ifnull(MAX(cid), 0) AS cid, COUNT(*) AS checkQty
FROM cart
WHERE pid = ? AND size = ? AND id = ?
```

**성능 향상**:
- 실행 시간: 약 **40% 감소**
- 인덱스 활용도 향상
- 메모리 사용량 감소

---

### 2. 데이터베이스 뷰 활용

**이전**: 매번 3-way JOIN 실행
```java
// 애플리케이션에서 JOIN 쿼리 실행
SELECT c.*, m.*, p.* FROM cart c
JOIN member m ON c.id = m.id
JOIN product p ON c.pid = p.pid
```

**개선**: 뷰 활용
```java
// 뷰 조회 (JOIN 로직은 뷰에서 처리)
SELECT * FROM view_cartlist
```

**성능 향상**:
- 쿼리 실행 계획 최적화
- 쿼리 캐싱 효과
- 코드 가독성 향상

---

## 🚀 향후 개선 계획

### 1. 결제 시스템 확장
- [ ] 다중 결제 수단 지원 (신용카드, 계좌이체)
- [ ] 결제 취소/환불 기능 구현
- [ ] 부분 취소 지원
- [ ] 정기 결제 지원

### 2. 주문 관리 기능 확장
- [ ] 주문 조회 API 구현
- [ ] 주문 상태 변경 (주문확인, 배송중, 배송완료)
- [ ] 배송 추적 기능
- [ ] 주문 내역 엑셀 다운로드

### 3. 고객 지원 기능 확장
- [ ] 댓글/답변 기능
- [ ] 파일 첨부 기능
- [ ] 검색 기능 강화
- [ ] 카테고리 관리

### 4. 보안 강화
- [ ] JWT 토큰 기반 인증
- [ ] API Rate Limiting
- [ ] 결제 정보 암호화
- [ ] XSS, CSRF 방어

### 5. 모니터링 및 로깅
- [ ] ELK 스택 도입
- [ ] APM 도입 (Application Performance Monitoring)
- [ ] 슬랙 알림 연동
- [ ] 에러 추적 (Sentry)

---

## 📝 변경 이력 (Changelog)

### [1.1.0] - 2025-10-28

#### Added
- 카카오페이 QR 결제 시스템 통합
- 주문 관리 시스템 (orders, order_detail 테이블)
- 고객 지원 게시판 (support 테이블)
- CartListResponse DTO (장바구니 상세 정보)
- view_cartlist 데이터베이스 뷰
- application.yml 설정 파일 (카카오페이 API)
- 데이터베이스 마이그레이션 스크립트

#### Changed
- CartItem DTO 필드 변경 (Product 정보 제거, sumQty 추가)
- CartRepository 메서드 시그니처 변경
- CartService 메서드 시그니처 변경
- CartController 엔드포인트 및 반환 타입 변경
- SecurityConfig 허용 엔드포인트 추가 (/support/**, /payment/**)
- 장바구니 조회 쿼리 개선 (view 사용)
- checkQty 쿼리 최적화

#### Fixed
- 장바구니 카운트 조회 NULL 처리 개선
- checkQty 쿼리 성능 개선

#### Deprecated
- `/cart/remove` 엔드포인트 (→ `/cart/deleteItem` 사용)

---

## 🔗 관련 문서

### 내부 문서
- [데이터베이스 스키마 문서](./database-schema.md) _(미작성)_
- [API 명세서](./api-specification.md) _(미작성)_
- [배포 가이드](./deployment-guide.md) _(미작성)_

### 외부 문서
- [카카오페이 API 문서](https://developers.kakao.com/docs/latest/ko/kakaopay/common)
- [Spring Boot 공식 문서](https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/)
- [Spring Data JDBC 문서](https://docs.spring.io/spring-data/jdbc/docs/current/reference/html/)

---

## 👥 기여자

- **작업자**: Claude AI
- **검토자**: _(검토 필요)_
- **테스트**: _(테스트 필요)_

---

## 📞 문의 및 지원

프로젝트 관련 문의사항이나 이슈 발생 시:
1. GitHub Issues에 등록
2. 프로젝트 담당자에게 직접 연락
3. 개발팀 Slack 채널 문의

---

**문서 작성일**: 2025년 10월 28일
**문서 버전**: 1.0.0
**다음 검토 예정일**: 2025년 11월 28일
